### d3guard

> éžå¸¸é—æ†¾è¿™é¢˜æœ€ç»ˆæ²¡æœ‰è§£ï¼Œä¹Ÿè®¸æ˜¯å‡ºé¢˜ä¸Šè¿˜æœ‰å¯ä»¥æ”¹è¿›çš„ç©ºé—´ï¼Œæ¬¢è¿Žå¯¹UEFI PWNæ–¹é¢æ„Ÿå…´è¶£çš„å¸ˆå‚…ç§ä¿¡äº¤æµï¼

#### 1. Analysis

è§‚å¯Ÿå¯åŠ¨è„šæœ¬çš„å‚æ•°å¯ä»¥å‘çŽ°ï¼ŒQEMUåœ¨å¯åŠ¨æ—¶å‘pflashï¼ˆå¯ä»¥çœ‹æˆæ˜¯biosï¼‰å†™å…¥äº†ä¸€ä¸ªå«åšOVMF.fdçš„å›ºä»¶ï¼Œå¹¶ä¸”å°†`./content`ç›®å½•æŒ‚è½½ä¸ºäº†ä¸€ä¸ªfatæ ¼å¼çš„é©±åŠ¨å™¨ã€‚ç†Ÿæ‚‰UEFIå¼€å‘çš„é€‰æ‰‹åº”è¯¥å¾ˆå¿«å¯ä»¥æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªUEFI PWNï¼Œå³é€šè¿‡UEFIçŽ¯å¢ƒä¸‹çš„æ¼æ´žåˆ©ç”¨å®Œæˆææƒ

> é¢˜ç›®æºæ–‡ä»¶çš„æ‰€æœ‰æ”¹åŠ¨åŸºäºŽedk2é¡¹ç›®ï¼š[https://github.com/tianocore/edk2](https://github.com/tianocore/edk2)

è¿è¡Œå¯åŠ¨è„šæœ¬ä¸”ä¸åšä»»ä½•æ“ä½œå°†ä¼šç›´æŽ¥è¿›å…¥æ“ä½œç³»ç»Ÿï¼Œå¹¶åˆ‡æ¢åˆ°ä½Žæƒé™ç”¨æˆ·ã€‚è¯¥ç”¨æˆ·æ²¡æœ‰æ ¹ç›®å½•ä¸‹flagæ–‡ä»¶çš„è¯»æƒé™ã€‚ç»“åˆé¢˜ç›®æè¿°ä¸­çš„`cat /flag`å¯ä»¥å¾—çŸ¥éœ€è¦è¿›è¡ŒæŸç§æ–¹å¼çš„ææƒä»¥è¯»å–flagå†…å®¹

```
/ $ ls -al /flag
-r--------    1 0        0               25 Feb 17 17:33 /flag
/ $ id
uid=1000 gid=1000 groups=1000
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œedk2ä¼šæä¾›UIå’ŒEFI SHELLä¸¤ç§äº¤äº’æ–¹å¼è®©ç”¨æˆ·è¿è¡ŒEFIç¨‹åºæˆ–è€…è¿›è¡ŒBootå‚æ•°çš„ç›¸å…³è®¾ç½®ã€‚æ£€æŸ¥`boot.nsh`å¯ä»¥å‘çŽ°é»˜è®¤æƒ…å†µä¸‹å†…æ ¸çš„å¯åŠ¨å‚æ•°ä¸ºï¼š`bzImage console=ttyS0 initrd=rootfs.img rdinit=/init quiet`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœæˆ‘ä»¬èƒ½å¤Ÿè¿›å…¥UIæˆ–è€…EFI SHELLäº¤äº’ç•Œé¢ï¼Œç„¶åŽä¿®æ”¹Bootå‚æ•°ä¸º`bzImage console=ttyS0 initrd=rootfs.img rdinit=/bin/ash quiet`å°±å¯ä»¥ä»¥root shellçš„æ–¹å¼è¿›å…¥æ“ä½œç³»ç»Ÿï¼Œè¯»å–flagæ–‡ä»¶ã€‚

ä½†æ˜¯ç•™æ„å¯åŠ¨è¿‡ç¨‹çš„è¾“å‡ºä¼šå‘çŽ°ï¼Œè¿›å…¥EFI SHELLå‰çš„å€’è®¡æ—¶ç›´æŽ¥è¢«æŽ è¿‡äº†ï¼ˆå› ä¸ºæˆ‘æŠŠå…¥å£é€»è¾‘patchæŽ‰äº†ï¼‰ã€‚äºŽæ˜¯åªèƒ½å°è¯•åŽ»è¿›å…¥UIäº¤äº’ç•Œé¢ã€‚edk2è¿›å…¥UIäº¤äº’ç•Œé¢çš„å¿«æ·é”®ä¸ºF2ï¼ˆæˆ–F12ï¼‰ï¼Œåœ¨å¯åŠ¨æ—¶é•¿æŒ‰è¯¥æŒ‰é”®å³å¯è¿›å…¥UIäº¤äº’ç¨‹åºã€‚ç„¶è€Œåœ¨æœ¬é¢˜ä¸­ï¼Œå¹¶ä¸ä¼šç›´æŽ¥è¿›å…¥Uiäº¤äº’ç•Œé¢ï¼Œè€Œæ˜¯å…ˆè¿›å…¥äº†d3guardå­ç¨‹åºï¼Œå¦‚ä¸‹ï¼š

```
BdsDxe: loading Boot0000 "UiApp" from Fv(7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1)/FvFile(462CAA21-7614-4503-836E-8AB6F4662331)
BdsDxe: starting Boot0000 "UiApp" from Fv(7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1)/FvFile(462CAA21-7614-4503-836E-8AB6F4662331)
```

![](https://i.imgur.com/fpyojin.png)

#### 2. Reverse

çŽ°åœ¨é¦–è¦ä»»åŠ¡å°±æ˜¯å¯¹`UiApp`è¿›è¡Œé€†å‘åˆ†æžå¯»æ‰¾èƒ½å¤Ÿè¿›å…¥æ­£å¸¸Uiäº¤äº’çš„æ–¹å¼ã€‚å€ŸåŠ©ä¸€äº›å·¥å…·å¯ä»¥è½»æ¾åœ°å°†`UiApp`æ¨¡å—é•œåƒæå–å‡ºæ¥ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ï¼šhttps://github.com/yeggor/uefi_retool

é€šè¿‡é€†å‘å¯ä»¥å‘çŽ°ä¸¤ä¸ªä¸»è¦çš„æ¼æ´žï¼Œä¸€ä¸ªæ˜¯å°è¯•ç”¨Administratorèº«ä»½ç™»å½•æ—¶ï¼Œå­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žï¼Œè¯¥æ¼æ´žå¯ä»¥æ³„éœ²æ ˆä¸Šçš„åœ°å€ä¿¡æ¯ï¼ŒåŒ…æ‹¬é•œåƒåœ°å€å’Œæ ˆåœ°å€ï¼š

> ä¸€äº›é˜Ÿä¼ç”±äºŽæ²¡æ³¨æ„åˆ°å…³äºŽè¿™ä¸ªæ¼æ´žçš„hintå¯¼è‡´å·®ä¸€ç‚¹æ²¡æ‹¿åˆ°flagï¼Œæ·±æ„Ÿå¯æƒœðŸ˜­ï¼ï¼ï¼

![](https://i.imgur.com/DfCEqEY.png)

è¿˜æœ‰ä¸€ä¸ªæ¼æ´žæ˜¯åœ¨ç¼–è¾‘ç”¨æˆ·æè¿°ä¿¡æ¯çš„æ—¶å€™å­˜åœ¨å †æº¢å‡ºï¼ˆè¿™ä¸€ç‚¹å¤§éƒ¨åˆ†é˜Ÿä¼éƒ½å‘çŽ°äº†ï¼‰ï¼š

![](https://i.imgur.com/Xhubiq9.png)

é™¤äº†å¯¹äºŽ`UiApp`é•œåƒçš„é€†å‘åˆ†æžï¼Œè¿˜éœ€è¦é˜…è¯»edk2ä¸­AllocatePoolçš„å…·ä½“å®žçŽ°æ–¹å¼ï¼Œè¿™å…³ç³»åˆ°æ¼æ´žåˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚ï¼Œè¿™éƒ¨åˆ†æš‚æ—¶çœç•¥

> ç›¸å…³ä»£ç ä½äºŽï¼šhttps://github.com/tianocore/edk2/blob/master/MdeModulePkg/Core/Dxe/Mem/Pool.c

#### 3. Exploit

é€šè¿‡åŠ¨æ€è°ƒè¯•å‘çŽ°ï¼Œ`1. New Visitor`ä¹‹åŽï¼Œ`visitor->name`å’Œ`visitor->desc`ä½äºŽç›¸é‚»çš„å†…å­˜åŒºé—´ä¸Šï¼Œå°†ä¸¤è€…è°ƒæ¢ä½ç½®è®©`visitor->desc`ä½äºŽä½Žåœ°å€å¤„ï¼Œå³å¯é€šè¿‡å †æº¢å‡ºæ¼æ´žè¦†ç›–`visitor->desc`çš„`POOL_TAIL`å’Œ`visitor->name`çš„`POOL_HEAD`

> ä¸»è¦å…³æ³¨POOL_HEADç»“æž„ä½“

```
typedef struct {
  UINT32             Signature;
  UINT32             Reserved;
  EFI_MEMORY_TYPE    Type;
  UINTN              Size;
  CHAR8              Data[1];
} POOL_HEAD;
```

ç»“åˆå¯¹AllocatePoolç›¸å…³æºä»£ç çš„é˜…è¯»ï¼Œå‘çŽ°å½“è°ƒç”¨`FreePool`å‡½æ•°æ—¶ï¼Œedk2ä¼šæ ¹æ®`POOL_HEAD->EFI_MEMORY_TYPE`çš„ä¸åŒè€Œå°†å †å—æ”¾å…¥ä¸åŒçš„é“¾è¡¨ä¸­ï¼Œè€Œåˆ†é…`visitor->name`å’Œ`visitor->desc`æ—¶ï¼ŒAllocatePoolå‚æ•°æ‰€ç”¨çš„`EFI_MEMORY_TYPE`ä¸º`EfiReservedMemoryType`ï¼ˆå³å¸¸æ•°0ï¼‰ã€‚å¦‚æžœé€šè¿‡æº¢å‡ºä¿®æ”¹`visitor->name`çš„`POOL_HEAD->EFI_MEMORY_TYPE`ä¸ºåˆ«çš„å€¼ï¼Œå³å¯å°†å…¶æ”¾å…¥å…¶å®ƒé“¾è¡¨ä¸­ï¼Œå†æ¬¡ç”³è¯·ä¹Ÿä¸ä¼šè¢«å–å‡ºã€‚

![](https://i.imgur.com/13bukEs.png)

![](https://i.imgur.com/aaLRcqD.png)


æœ€åŽåœ¨`4. Confirm && Enter OS`ä¸­è¿˜ä¼šåˆ†é…ä¸€æ¬¡å †å†…å­˜ï¼Œç”¨äºŽæ‹·è´`visitor->name`å’Œ`visitor->desc`å¹¶ä¿å­˜ã€‚è¿™æ—¶å€™`AllocatePool()`æ‰€ç”³è¯·çš„`EFI_MEMORY_TYPE`ä¸º`EfiACPIMemoryNVS`ï¼ˆå³å¸¸æ•°10ï¼‰ã€‚

![](https://i.imgur.com/bNrOtQr.png)

ç»“åˆä¸Šé¢çš„åˆ†æžï¼Œå°†`visitor->name`çš„`POOL_HEAD->EFI_MEMORY_TYPE`è®¾ç½®ä¸º10ï¼Œå¹¶å°†å…¶Freeã€‚æ­¤æ—¶åŽŸå…ˆåˆ†é…ç»™`visitor->name`çš„å †å—è¿›å…¥äº†ç©ºé—²é“¾è¡¨ï¼ˆè¿™æ˜¯ä¸ªåŒé“¾è¡¨ï¼‰ï¼Œé€šè¿‡åŠ«æŒåŒé“¾è¡¨çš„FDå’ŒBKæŒ‡é’ˆå¯ä»¥å‘ä»»æ„åœ°å€å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„å€¼ã€‚ç»“åˆæœ€å¼€å§‹æ³„éœ²å‡ºçš„æ ˆåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å°†d3guardå‡½æ•°çš„è¿”å›žåœ°å€è¦†ç›–æŽ‰ä»¥åŠ«æŒç¨‹åºæµã€‚

> å®žé™…ä¸Šæœ€åŽä¸€æ­¥çš„è§£æ³•æ˜¯å¼€æ”¾æ€§çš„ï¼Œåªè¦è¾¾åˆ°åŠ«æŒæŽ§åˆ¶æµçš„ç›®çš„å°±è¡Œ

ç”±äºŽ`d3guard()`çš„ä¸Šå±‚å‡½æ•°`_ModuleEntryPoint+718`çš„ä½ç½®ä¼šåˆ¤æ–­`d3guard()`çš„è¿”å›žå€¼ä»¥å†³å®šæ˜¯å¦è¿›å…¥UIäº¤äº’ç•Œé¢ï¼Œæ‰€ä»¥æœ€ç›´æŽ¥çš„åšæ³•æ˜¯è¦†ç›–d3guardè¿”å›žåœ°å€è·³è¿‡ifåˆ†æ”¯ç›´æŽ¥è¿›å…¥UIäº¤äº’ç•Œé¢ã€‚ä½†æ˜¯å®žé™…ç¼–å†™è„šæœ¬æ—¶å‘çŽ°æ³„éœ²å‡ºçš„ç¨‹åºåœ°å€ä¸Žè·³è½¬çš„ç›®æ ‡åœ°å€åç§»ä¸æ˜¯å¾ˆç¨³å®šï¼ˆä½†æ˜¯æ¦‚çŽ‡å¾ˆå¤§ï¼‰ï¼ŒäºŽæ˜¯è¦†ç›–d3guardè¿”å›žåœ°å€ä¸ºä¸€ä¸ªæ ˆä¸Šshellcodeçš„åœ°å€ï¼ˆæ ˆä¸Šæ²¡å¼€NXé˜²æŠ¤ï¼‰ï¼Œshellcodeå¯ä»¥åœ¨è¾“å…¥Admin pass keyæ—¶æå‰éƒ¨ç½²ã€‚å€ŸåŠ©shellcodeä»¥åŠå¯„å­˜å™¨ä¸­çš„é•œåƒåœ°å€ï¼Œå¯ä»¥è®¡ç®—å‡ºç¨³å®šçš„è·³è½¬ç›®æ ‡åœ°å€ã€‚

æˆåŠŸè¿›å…¥Uiäº¤äº’ç•Œé¢åŽï¼Œåªéœ€è¦é€šè¿‡æ“ä½œèœå•æ·»åŠ ä¸€ä¸ªæ–°çš„å¯åŠ¨é¡¹ï¼Œå¹¶å°†å‚æ•°`rdinit`è®¾ç½®ä¸º`/bin/sh`ç„¶åŽé€šè¿‡å…¶è¿›å…¥æ“ä½œç³»ç»Ÿï¼Œå³å¯èŽ·å¾—rootæƒé™ã€‚

> å¼€å§‹æ²¡æƒ³åˆ°åŠ å¯åŠ¨é¡¹è¿™ä¸ªæ­¥éª¤ä¹Ÿèƒ½æˆä¸ºä¸€ä¸ªå‘ç‚¹...å…¶å®žå¯ä»¥ç¼–è¯‘ä¸€ä»½åŽŸç‰ˆOVMF.fdï¼Œè¿›å…¥`Boot Maintenance Manager`ï¼Œè¿›å…¥` Boot Options`ï¼Œé€‰æ‹©`Add Boot Option`ï¼Œé€‰æ‹©å†…æ ¸é•œåƒ`bzImage`ï¼Œè®¾ç½®å¯åŠ¨é¡¹åç§°`rootshell`ï¼Œè®¾ç½®å†…æ ¸å¯åŠ¨çš„é™„åŠ å‚æ•°`console=ttyS0 initrd=rootfs.img rdinit=/bin/sh quiet`ï¼Œæœ€åŽè¿”å›žä¸»é¡µé¢é€‰æ‹©å¯åŠ¨é¡¹èœå•ï¼Œæ‰¾åˆ°`rootshell`è¿™ä¸€é¡¹

---

> é¢˜ç›®é™„ä»¶å’Œåˆ©ç”¨è„šæœ¬ï¼šhttps://github.com/yikesoftware/d3ctf-2022-pwn-d3guard

---